name: Build echworker (N1 armvirt-64)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      CCACHE_DIR: ${{ github.workspace }}/.ccache

    steps:
      - name: Checkout OpenWrt
        uses: actions/checkout@v4
        with:
          repository: openwrt/openwrt
          ref: v23.05.5
          path: openwrt

      - name: Install deps
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential clang flex bison g++ gawk gettext \
            git libncurses-dev libssl-dev python3 \
            rsync unzip zlib1g-dev file wget ccache

      - name: Restore cache
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir
            openwrt/toolchain
            .ccache
          key: openwrt-armvirt-64-23.05

      - name: Add echworker feed
        run: |
          cd openwrt
          echo "src-link echworker https://github.com/ntbowen/echworker-for-openwrt.git" >> feeds.conf.default
          ./scripts/feeds update -a
          ./scripts/feeds install -a

          LUCI_MK=$(find package/feeds/echworker -name Makefile | grep luci || true)
          if [ -n "$LUCI_MK" ]; then
            sed -i 's/+dns2socks//g' "$LUCI_MK"
          fi

      - name: Configure target
        run: |
          cd openwrt
          printf "%s\n" \
            "CONFIG_TARGET_armvirt=y" \
            "CONFIG_TARGET_armvirt_64=y" \
            "CONFIG_TARGET_armvirt_64_Default=y" \
            "CONFIG_CCACHE=y" \
            "CONFIG_PACKAGE_echworker-go=m" \
            "CONFIG_PACKAGE_luci-app-echworkers=m" \
            > .config
          make defconfig

      - name: Build toolchain
        run: |
          cd openwrt
          make toolchain/install -j$(nproc)

      - name: Build echworker
        run: |
          cd openwrt
          make package/feeds/echworker/echworker-go/compile -j$(nproc) V=s
          ls openwrt/package/feeds/echworker
          
          
      - name: Build luci-app
        run: |
          cd openwrt
          make package/feeds/echworker/luci-app-echworkers/compile -j$(nproc) V=s
          ls openwrt/package/feeds/luci-app-echworkers

      - name: Collect IPK
        run: |
          mkdir -p output
          find openwrt/bin/packages -name "*echworker*.ipk" -exec cp {} output/ \;

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: echworker-n1-${{ github.run_number }}
          files: output/*.ipk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
