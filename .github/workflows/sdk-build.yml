name: Build echworker for Phicomm N1 (ARM64 SDK)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential clang flex g++ gawk \
          gettext git libncurses-dev libssl-dev python3 \
          rsync unzip zlib1g-dev file wget

    - name: Download OpenWrt SDK (armvirt-64 SNAPSHOT)
      run: |
        mkdir openwrt-sdk
        SDK_URL=$(curl -s https://downloads.openwrt.org/snapshots/targets/armvirt/64/ \
          | grep -o 'openwrt-sdk-armvirt-64[^"]*Linux-x86_64.tar.xz' \
          | head -n 1)
        echo "Found SDK: $SDK_URL"
        wget -O sdk.tar.xz "https://downloads.openwrt.org/snapshots/targets/armvirt/64/$SDK_URL"
        tar -xf sdk.tar.xz -C openwrt-sdk --strip-components=1



    - name: Add echworker package
      run: |
        cd openwrt-sdk
        git clone https://github.com/ntbowen/echworker-for-openwrt.git \
          package/echworker-for-openwrt

    # ⚠️ 不更新 feeds，避开 git.openwrt.org 503
    - name: Prepare SDK
      run: |
        cd openwrt-sdk
        make defconfig

    - name: Build echworker ipk
      run: |
        cd openwrt-sdk
        make package/echworker-for-openwrt/compile -j$(nproc) V=s

    - name: Collect ipk
      run: |
        mkdir -p output
        find openwrt-sdk/bin/packages -type f -name "*echworker*.ipk" -exec cp {} output/ \;

    - name: Upload ipk
      uses: actions/upload-artifact@v4
      with:
        name: echworker-phicomm-n1-ipk
        path: output/
