name: Build echworker for OpenWrt

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Prepare build environment
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential clang flex g++ gawk gcc-multilib \
          gettext git libncurses-dev libssl-dev python3 python3-distutils \
          rsync unzip zlib1g-dev file wget
          
      - name: Download OpenWrt SDK (armvirt-64)
        run: |
          mkdir openwrt-sdk
          wget -O sdk.tar.xz \
            https://downloads.openwrt.org/releases/23.05.5/targets/armvirt/64/openwrt-sdk-23.05.5-armvirt-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz
          tar -xf sdk.tar.xz -C openwrt-sdk --strip-components=1
      
      - name: Add echworker package
        run: |
          cd openwrt-sdk
          git clone https://github.com/ntbowen/echworker-for-openwrt.git \
            package/echworker-for-openwrt
      
      - name: Build echworker
        run: |
          cd openwrt-sdk
          make defconfig
          make package/echworker-for-openwrt/compile -j$(nproc) V=s

