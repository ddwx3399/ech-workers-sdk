name: Build echworker for Phicomm N1 (ARM64 SDK Docker)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4

    - name: Pull OpenWrt SDK Docker (armvirt-64)
      run: |
        docker pull ghcr.io/openwrt/sdk:armvirt-64

    - name: Build echworker ipk
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          ghcr.io/openwrt/sdk:armvirt-64 \
          /bin/bash -c "
            set -e
            cd /home/build/openwrt
            git clone https://github.com/ntbowen/echworker-for-openwrt.git \
              package/echworker-for-openwrt
            make defconfig
            make package/echworker-for-openwrt/compile -j\$(nproc) V=s
            cp bin/packages/*/*/*echworker*.ipk /workspace/
          "

    - name: Upload ipk
      uses: actions/upload-artifact@v4
      with:
        name: echworker-phicomm-n1-ipk
        path: "*.ipk"
